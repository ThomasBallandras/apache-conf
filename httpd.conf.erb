# Listen: Allows you to bind Apache to specific IP addresses and/or ports.
Listen <%= ENV['PORT'] %>
###

# ServerName gives the name and port that the server uses to identify itself.
# If your host doesn't have a registered DNS name, enter its IP address here.
ServerName tb-testbp.osc-fr1.scalingo.io:<%= ENV['PORT'] %>

# ServerRoot: The top of the directory tree under which the server's
# configuration, error, and log files are kept.
# Assume that Apache HTTP server is installed in "d:\myProject\apache2"
# ServerRoot <%= ENV['APACHE_DIR'] %>
ServerRoot /app/vendor/apache2

#LoadModule mpm_event_module <%= ENV['APACHE_DIR'] %>/usr/lib/apache2/modules/mod_mpm_event.so
#LoadModule access_compat_module <%= ENV['APACHE_DIR'] %>/usr/lib/apache2/modules/mod_access_compat.so
#LoadModule authz_host_module <%= ENV['APACHE_DIR'] %>/usr/lib/apache2/modules/mod_authz_host.so
#LoadModule headers_module <%= ENV['APACHE_DIR'] %>/usr/lib/apache2/modules/mod_headers.so
#LoadModule rewrite_module <%= ENV['APACHE_DIR'] %>/usr/lib/apache2/modules/mod_rewrite.so
LoadModule mpm_event_module /app/.apt/usr/lib/apache2/modules/mod_mpm_event.so
LoadModule access_compat_module /app/.apt/usr/lib/apache2/modules/mod_access_compat.so
LoadModule authz_host_module /app/.apt/usr/lib/apache2/modules/mod_authz_host.so
LoadModule headers_module /app/.apt/usr/lib/apache2/modules/mod_headers.so
LoadModule rewrite_module /app/.apt/usr/lib/apache2/modules/mod_rewrite.so
<% if ENV['APACHE_MODE'] == 'openidc' %>
#LoadModule auth_openidc_module <%= ENV['APACHE_DIR'] %>/usr/lib/apache2/modules/mod_auth_openidc.so
LoadModule auth_openidc_module /app/.apt/usr/lib/apache2/modules/mod_auth_openidc.so
<% end %>
<% if ENV['APACHE_MODE'] == 'mellon' %>
#LoadModule auth_mellon_module <%= ENV['APACHE_DIR'] %>/usr/lib/apache2/modules/mod_auth_mellon.so
LoadModule auth_mellon_module /app/.apt/usr/lib/apache2/modules/mod_auth_mellon.so
<% end %>

<VirtualHost *:443>
OIDCProviderIssuer https://app.franceconnect.gouv.fr
OIDCClientID xxxx
OIDCClientSecret xxx
OIDCProviderTokenEndpointAuth client_secret_post
OIDCProviderAuthorizationEndpoint https://app.franceconnect.gouv.fr/api/v1/authorize
OIDCProviderTokenEndpoint https://app.franceconnect.gouv.fr/api/v1/token
OIDCProviderUserInfoEndpoint https://app.franceconnect.gouv.fr/api/v1/userinfo
OIDCProviderEndSessionEndpoint https://app.franceconnect.gouv.fr/api/v1/logout
OIDCScope "email openid birthdate birthplace given_name family_name birthcountry gender"
OIDCRedirectURI "https://fc.montransportexceptionnel.interieur.gouv.fr/login-callback"
OIDCCryptoPassphrase "secret"
OIDCPassClaimsAs headers
OIDCAuthRequestParams "acr_values=eidas1"
OIDCSessionInactivityTimeout 1800
Header always edit Set-Cookie (.*) "$1; Secure"
#SSI_V1: Activation de l option Strict-Transport-Security
Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"

<Location /login-callback>
AuthType openid-connect
Require valid-user
LogLevel debug
</Location>

<Location /api-portail>
AuthType openid-connect
Require valid-user
ProxyPass http://xxx.xxx.xxx.xxx:443/api-portail
ProxyPassReverse http://xxx.xxx.xxx.xxx:443/api-portail
</Location>

<Location /api-sig>
AuthType openid-connect
Require valid-user
ProxyPass http://xxx.xxx.xxx.xxx:443/api-sig
ProxyPassReverse http://xxx.xxx.xxx.xxx:443/api-sig
</Location>

<Location /noprotected>
ProxyPass http://xxx.xxx.xxx.xxx:443/noprotected
ProxyPassReverse http://xxx.xxx.xxx.xxx:443/noprotected
</Location>

</VirtualHost>
